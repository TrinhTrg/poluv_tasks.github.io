<!doctype html>
<html lang="vi" class="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PoLuv Tasks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600;700&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,600;1,600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            serif: ['Playfair Display', 'serif'],
            script: ['Dancing Script', 'cursive'],
          },
          colors: {
            header: '#F2EAEA',
            main: '#FAF7F2',
            card: '#F5E6D3',
            completed: '#EED6B5',
            pending: '#C8AFA9',
          },
          boxShadow: {
            'smooth': '0 4px 20px rgba(0,0,0,0.03)',
            'task': '0 2px 8px rgba(92, 67, 46, 0.08)',
          },
        }
      }
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1C4B9; border-radius: 10px; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .smooth-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    .task-shadow { box-shadow: 0 2px 8px rgba(92, 67, 46, 0.08); }
    @keyframes bell-ring {
      0%, 100% { transform: rotate(0); }
      10%, 30%, 50%, 70%, 90% { transform: rotate(15deg); }
      20%, 40%, 60%, 80% { transform: rotate(-15deg); }
    }
    .bell-animate { animation: bell-ring 2s ease-in-out infinite; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Custom Radio for Color Picker */
    .color-radio:checked + label { outline: 2px solid #94a3b8; outline-offset: 2px; transform: scale(1.1); }
  </style>
</head>
<body class="bg-main text-gray-800 dark:bg-slate-900 dark:text-gray-100 antialiased font-sans min-h-screen flex flex-col transition-colors duration-300">
  <header class="bg-header dark:bg-slate-800 sticky top-0 z-30 transition-all duration-300 shadow-sm border-b border-transparent dark:border-slate-700">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-20">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full overflow-hidden shadow-md">
             <img src="./images/poluv_light.png" alt="Logo" class="w-full h-full object-cover dark:hidden">
             <img src="./images/poluv_dark.png" alt="Logo" class="w-full h-full object-cover hidden dark:block">
          </div>
          <div>
            <div class="text-2xl font-serif font-bold italic text-gray-900 dark:text-white tracking-wide">
                PoLuv <span class="font-sans font-light text-sm not-italic ml-0.5 uppercase tracking-widest text-gray-600">Tasks</span>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-4 md:gap-6">
            <button id="themeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition text-gray-600 dark:text-gray-300">
                <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <div class="relative cursor-pointer group" onclick="requestNotificationPermission()">
                <svg id="bellIcon" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-600 dark:text-gray-300 group-hover:text-gray-900 dark:group-hover:text-white transition" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <div id="notifBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center shadow-sm">0</div>
                <div class="absolute right-0 top-10 w-64 bg-white dark:bg-slate-800 p-3 rounded-xl shadow-xl border border-gray-100 dark:border-slate-700 hidden group-hover:block z-50">
                    <div class="text-xs font-bold text-gray-400 uppercase mb-2">Upcoming (24h)</div>
                    <ul id="notifList" class="text-sm text-gray-700 dark:text-gray-300 space-y-2"><li class="text-gray-400 italic">No upcoming tasks</li></ul>
                </div></div>
            <div class="flex items-center gap-4 border-l pl-6 border-gray-300 dark:border-slate-600">
                <div class="hidden md:block text-right">
                    <div class="text-xs text-gray-500 dark:text-gray-400 uppercase tracking-wider">Welcome back</div>
                    <div class="text-sm font-semibold">Trinh Tr∆∞∆°ng</div></div>
                <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-white dark:border-slate-600 shadow-md"><img src="https://i.pravatar.cc/150?img=33" alt="avatar" class="w-full h-full object-cover grayscale hover:grayscale-0 transition"></div>
            </div></div></div></div>
  </header>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-4">
      <h1 class="text-3xl md:text-4xl font-serif text-gray-900 dark:text-white leading-tight">
          Hello, <span id="userName" class="underline decoration-pink-300 decoration-2 underline-offset-4">Trinh</span>, 
          <span class="text-gray-500 dark:text-gray-400 font-sans font-light block sm:inline mt-2 sm:mt-0 sm:ml-2 text-2xl">Ready to focus?</span></h1></div>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex-grow flex flex-col">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <aside class="lg:col-span-3 space-y-6">
        <div><div class="text-pink-400 dark:text-pink-300 font-script text-4xl mb-1">Sunday</div><div id="currentFullDate" class="text-3xl font-serif text-gray-800 dark:text-gray-200"></div></div>
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-5 smooth-shadow transition-colors">
            <div class="flex items-center justify-between mb-4 px-4 pt-2">
                <button onclick="changeMonth(-1)" class="p-0 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg></button>
                <button id="btnOpenCalendarSettings" class="px-4 py-1.5 rounded-xl hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm transition group border border-transparent hover:border-gray-200 dark:hover:border-slate-600">
                    <span id="currentMonth" class="text-center font-serif text-lg font-bold text-gray-800 dark:text-white group-hover:text-pink-600 dark:group-hover:text-pink-400 select-none"></span></button>
                <button onclick="changeMonth(1)" class="p-0 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg></button>
            </div>
          <div class="flex gap-3"><div class="pt-[28px]"> <div id="calendarWeeks" class="grid grid-cols-1 gap-y-2"></div></div><div id="calendar" class="w-full"></div></div>
        </div>
        <div class="bg-white dark:bg-[#1E293B] rounded-3xl p-6 shadow-sm smooth-shadow border border-gray-100 dark:border-gray-700 flex-grow">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg font-serif text-gray-800 dark:text-white">Today's Schedule</h3>
                <span id="todayDateDisplay" class="text-xs text-gray-400 font-medium font-sans"></span>
            </div>
            <div id="todayList" class="space-y-3 overflow-y-auto max-h-[300px] pr-1">
                <div class="text-center text-gray-400 text-sm py-4 italic">Loading...</div>
            </div>
        </div>
      </aside>
      <section class="lg:col-span-9 space-y-8">
        <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm p-4 rounded-2xl flex flex-col md:flex-row md:items-center justify-between gap-4 border border-white/60 dark:border-slate-700/60">
            <div class="flex gap-2 overflow-x-auto pb-2 md:pb-0">
                <button id="btnToggleView" class="flex items-center gap-2 bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-2 rounded-xl text-sm font-bold hover:bg-indigo-200 transition" onclick="toggleViewMode()">
                    <svg id="iconList" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    <svg id="iconChart" class="w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
                    <span>View</span>
                </button>
                <div class="relative group">
                    <select id="filterStatus" class="appearance-none bg-[#EAD6C0] dark:bg-slate-700 hover:bg-[#E0CCB7] text-gray-800 dark:text-white py-2 pl-4 pr-8 rounded-xl text-sm font-medium focus:outline-none cursor-pointer transition border-none">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="relative group">
                    <select id="filterCategory" class="appearance-none bg-[#EAD6C0] dark:bg-slate-700 hover:bg-[#E0CCB7] text-gray-800 dark:text-white py-2 pl-4 pr-8 rounded-xl text-sm font-medium focus:outline-none cursor-pointer transition border-none">
                        <option value="all">All Categories</option>
                        <option value="Work">Work</option>
                        <option value="Homework">Homework</option>
                        <option value="Meeting">Meeting</option>
                        <option value="Personal">Personal</option>
                        <option value="Other">Other</option>
                    </select>
                </div>  
                <div class="relative group">
                    <select id="sortSelect" class="appearance-none bg-[#EAD6C0] dark:bg-slate-700 hover:bg-[#E0CCB7] text-gray-800 dark:text-white py-2 pl-4 pr-8 rounded-xl text-sm font-medium focus:outline-none cursor-pointer transition border-none">
                        <option value="created_desc">Newest</option>
                        <option value="priority_desc">Priority</option>
                    </select></div></div>
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="relative w-full md:w-64 group"><span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-4 w-4 text-gray-400 group-focus-within:text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></span>
                    <input id="searchInput" type="search" placeholder="Search..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200 dark:border-slate-600 focus:border-pink-300 focus:ring focus:ring-pink-200 text-sm bg-white dark:bg-slate-700 dark:text-white transition outline-none" /></div>
                <button id="btnAdd" class="flex-shrink-0 bg-[#6FA774] hover:bg-[#5E9163] text-white px-4 py-2 rounded-xl text-2xl font-light shadow-lg hover:shadow-green-200 transition pb-3 h-10 w-10 flex items-center justify-center">+</button></div></div>
        <div id="listView" class="fade-in">
            <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            <div class="flex justify-center mt-10 mb-8">
                <button id="btnLoadMore" class="px-6 py-2.5 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 text-gray-600 dark:text-gray-300 font-medium rounded-xl hover:bg-gray-50 dark:hover:bg-slate-700 transition shadow-sm">Load more</button>
            </div>
        </div>
        <div id="analyticsView" class="hidden fade-in bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-sm flex flex-col gap-6">
            <div>
                <h3 class="text-xl font-serif font-bold text-gray-800 dark:text-white mb-1 text-left">Task Overview</h3>
                <p class="text-xs text-gray-400 font-sans uppercase tracking-wider mb-4">Summary of recent activity</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="rounded-2xl p-4 bg-gradient-to-br from-purple-100 to-purple-200 dark:from-purple-900/40 dark:to-purple-700/30 shadow-sm border border-white/60 dark:border-purple-600/40 flex flex-col gap-1">
                        <span class="text-xs uppercase font-semibold text-purple-900 dark:text-purple-200 tracking-wide">Completed Tasks</span>
                        <div class="text-5xl font-serif text-purple-900 dark:text-white leading-none" id="overviewCompleted">0</div>
                    </div>
                    <div class="rounded-2xl p-4 bg-gradient-to-br from-rose-100 to-orange-100 dark:from-rose-900/40 dark:to-orange-800/30 shadow-sm border border-white/60 dark:border-rose-700/40 flex flex-col gap-1">
                        <span class="text-xs uppercase font-semibold text-rose-900 dark:text-rose-100 tracking-wide">Pending Tasks</span>
                        <div class="text-5xl font-serif text-rose-900 dark:text-white leading-none" id="overviewPending">0</div>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div>
                        <h4 class="text-lg font-serif font-bold text-gray-800 dark:text-white">Open Tasks in Categories</h4>
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-semibold">Visualized distribution</p>
                    </div>
                    <select id="analyticsRangeSelect" class="self-start sm:self-auto px-4 py-2 rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-sm font-medium text-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                        <option value="year">Year</option>
                    </select>
                </div>
                <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                    <div class="relative w-48 h-48">
                        <canvas id="taskChart"></canvas>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span id="openTasksTotal" class="text-4xl font-sans font-extrabold text-gray-800 dark:text-white leading-none drop-shadow-sm">0</span>
                            <span class="text-[11px] text-gray-500 dark:text-gray-400 font-bold uppercase tracking-widest mt-1">Open</span>
                        </div>
                    </div>
                    <ul id="categoryBreakdown" class="flex-1 w-full text-sm text-gray-600 dark:text-gray-300 space-y-3">
                        <li class="flex items-center justify-between bg-gray-50 dark:bg-slate-700/40 rounded-xl px-4 py-3 border border-gray-100 dark:border-slate-600">
                            <div class="flex items-center gap-3">
                                <span class="w-3 h-3 rounded-full bg-gray-300"></span>
                                <span class="font-medium">No open tasks</span>
                            </div>
                            <span class="font-semibold">0%</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
      </section>
    </div>
    <div class="mt-12 pt-8 border-t border-gray-200/60 dark:border-slate-700">
        <h3 class="text-lg font-serif italic text-gray-500 dark:text-gray-400 mb-6 text-center">Dashboard Summary</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-completed rounded-3xl p-6 relative overflow-hidden flex flex-col justify-between h-40">
                <div class="absolute -right-4 -top-4 text-white opacity-20 text-7xl rotate-12">‚úì</div>
                <div><div class="text-xs font-bold text-gray-800 uppercase tracking-widest mb-1">Completed</div><div class="text-sm text-gray-800/80">Tasks</div></div>
                <div id="statCompleted" class="text-5xl font-serif text-gray-900 leading-none">00</div>
            </div>
            <div class="bg-pending rounded-3xl p-6 relative overflow-hidden flex flex-col justify-between h-40">
                <div class="absolute -right-4 -top-4 text-white opacity-20 text-7xl rotate-12">?</div>
                <div><div class="text-xs font-bold text-white uppercase tracking-widest mb-1">Pending</div><div class="text-sm text-white/80">Tasks</div></div>
                <div id="statPending" class="text-5xl font-serif text-white leading-none">00</div></div>
            <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 smooth-shadow flex flex-col items-center justify-center h-40 relative overflow-hidden text-center transition-colors">
                    <div class="absolute top-0 right-0 w-20 h-full bg-gradient-to-l from-gray-50 dark:from-slate-700 to-transparent opacity-50"></div>
                    <div class="z-10">
                        <div class="text-sm font-bold text-cyan-600 dark:text-cyan-400 mb-2 uppercase tracking-wide">Tasks created</div>
                        <div id="statTotal" class="text-6xl font-serif text-gray-900 dark:text-white leading-none tracking-tight">000</div>
                    </div></div></div></div>
  </main> 
  <footer class="border-t border-gray-200 dark:border-slate-700 bg-[#F2EAEA] dark:bg-slate-900 py-6 mt-0 transition-colors">
      <div class="max-w-7xl mx-auto px-4 text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="font-sans font-bold text-gray-700">PoLuv Tasks</span>
          </div>
          <p class="text-gray-500 text-sm">¬© 2025 PoLuv Tasks. All Rights Reserved.</p>
      </div>
  </footer>
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden items-center justify-center bg-[#4A403A]/60 backdrop-blur-sm transition-opacity">
    <div class="bg-[#FAF7F2] dark:bg-slate-800 rounded-3xl p-8 w-full max-w-md smooth-shadow transform transition-all scale-100 border-4 border-white dark:border-slate-700 max-h-[90vh] overflow-y-auto">
      <h3 id="modalTitle" class="text-2xl font-serif font-semibold mb-6 text-gray-800 dark:text-white">Add New Task</h3>
      <form id="taskForm" class="space-y-4">
        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Title</label>
            <input id="taskTitle" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl focus:border-pink-300 dark:text-white outline-none transition" placeholder="e.g. Learn React" required />
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Description</label>
            <textarea id="taskDesc" rows="2" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl focus:border-pink-300 dark:text-white outline-none transition resize-none" placeholder="Details..."></textarea>
        </div>
        <div>
             <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Category</label>
             <div class="relative">
                 <select id="taskCategory" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl appearance-none outline-none dark:text-white cursor-pointer">
                     <option value="Work">üíº Work</option>
                     <option value="Homework">üìö Homework</option>
                     <option value="Meeting">üó£Ô∏è Meeting</option>
                     <option value="Personal">üë§ Personal</option>
                     <option value="Other">üì¶ Other</option>
                 </select>
                 <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-500">
                     <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                 </div></div></div>
        <div class="grid grid-cols-2 gap-4"><div>
                 <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Start</label>
                 <div class="flex flex-col gap-2">
                    <input id="taskStartDate" type="date" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl text-sm dark:text-white dark:scheme-dark" />
                    <input id="taskStartTime" type="time" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl text-sm dark:text-white dark:scheme-dark" />
                 </div></div>
            <div>
                 <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Due</label>
                 <div class="flex flex-col gap-2">
                    <input id="taskDueDate" type="date" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl text-sm dark:text-white dark:scheme-dark" />
                    <input id="taskDueTime" type="time" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl text-sm dark:text-white dark:scheme-dark" />
                 </div></div></div>
        <div>
            <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2 tracking-wider">Color Tag</label>
            <div id="colorPickerContainer" class="flex flex-wrap gap-3 justify-start"></div>
        </div>
        <div>
             <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Priority</label>
             <select id="taskPriority" class="w-full px-3 py-2 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl text-sm dark:text-white outline-none">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
             </select>
        </div>
        <div class="flex items-center justify-between pt-2">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Remind me (24h alert)</span>
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" id="taskNotify" class="sr-only peer">
              <div class="relative w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
            </label>
        </div>
        <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200 dark:border-slate-700">
          <button type="button" id="cancelModal" class="px-5 py-2.5 rounded-xl border border-gray-300 dark:border-slate-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 font-medium transition">Cancel</button>
          <button type="submit" class="px-5 py-2.5 rounded-xl bg-black dark:bg-indigo-600 text-white hover:bg-gray-800 dark:hover:bg-indigo-700 font-medium shadow-lg transition">Save Task</button>
        </div>
      </form>
    </div>
  </div>
  <div id="pomodoroModal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-indigo-900/80 backdrop-blur-md transition-opacity">
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl border-4 border-indigo-200 dark:border-indigo-900">
        <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">‚è∞</div>
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Focus Mode</h3>
        <p id="pomoTaskTitle" class="text-sm text-gray-500 dark:text-gray-400 mb-6 px-4 truncate">Task Name Here</p>
        <div class="text-6xl font-mono font-bold text-gray-900 dark:text-white mb-6 tracking-widest" id="timerDisplay">25:00</div>
        <div id="timerInputs" class="flex justify-center gap-2 mb-6">
            <input id="inputMin" type="number" min="1" max="60" value="25" class="w-16 text-center border rounded-lg p-2 dark:bg-slate-700 dark:text-white" />
            <span class="text-2xl self-center">:</span>
            <input id="inputSec" type="number" min="0" max="59" value="00" class="w-16 text-center border rounded-lg p-2 dark:bg-slate-700 dark:text-white" /></div>
        <div class="flex justify-center gap-3">
            <button id="btnPomoCancel" class="px-4 py-2 rounded-xl text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 transition">Cancel</button>
            <button id="btnPomoStart" class="px-6 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg font-bold transition">Start Focus</button>
            <button id="btnPomoPause" class="hidden px-6 py-2 rounded-xl bg-yellow-500 text-white hover:bg-yellow-600 shadow-lg font-bold transition">Pause</button>
        </div></div></div>
  <div id="dateSelectModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-[#4A403A]/60 backdrop-blur-sm transition-opacity">
    <div class="bg-[#FAF7F2] dark:bg-slate-800 rounded-3xl p-6 w-full max-w-sm smooth-shadow border-4 border-white dark:border-slate-700">
        <h3 class="text-xl font-serif font-semibold mb-4 text-gray-800 dark:text-white text-center">Jump to Date</h3>
        <div class="space-y-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Month</label>
                <select id="selectMonth" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl outline-none dark:text-white">
                    <option value="0">January</option> <option value="1">February</option> <option value="2">March</option>
                    <option value="3">April</option> <option value="4">May</option> <option value="5">June</option>
                    <option value="6">July</option> <option value="7">August</option> <option value="8">September</option>
                    <option value="9">October</option> <option value="10">November</option> <option value="11">December</option>
                </select></div>
            <div>
                <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 tracking-wider">Year</label>
                <input id="inputYear" type="number" class="w-full px-4 py-3 bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl outline-none dark:text-white" placeholder="2025">
            </div></div>
        <div class="flex justify-end gap-3">
            <button id="btnCloseDateModal" class="px-4 py-2 rounded-xl border border-gray-300 dark:border-slate-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 transition">Cancel</button>
            <button id="btnApplyDate" class="px-5 py-2 rounded-xl bg-pink-500 text-white hover:bg-pink-600 shadow-md font-bold transition">Go</button>
        </div></div></div>
  <div id="deleteModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-red-900/20 backdrop-blur-sm transition-opacity">
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 w-full max-w-sm smooth-shadow border-4 border-red-100 dark:border-red-900/50 text-center">
        <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg></div>
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Delete Task?</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-6 text-sm">Are you sure you want to delete this task? This action cannot be undone.</p>   
        <div class="flex justify-center gap-3">
            <button id="btnCancelDelete" class="px-5 py-2.5 rounded-xl border border-gray-300 dark:border-slate-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-700 font-medium transition">Cancel</button>
            <button id="btnConfirmDelete" class="px-5 py-2.5 rounded-xl bg-red-500 text-white hover:bg-red-600 font-bold shadow-lg transition">Delete</button>
        </div></div></div>
<script>
// --- 1. THEME LOGIC ---
const htmlEl = document.documentElement;
const themeToggleBtn = document.getElementById('themeToggle');
const sunIcon = document.getElementById('sunIcon');
const moonIcon = document.getElementById('moonIcon');

function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        htmlEl.classList.add('dark');
        moonIcon.classList.add('hidden');
        sunIcon.classList.remove('hidden');
    } else {
        htmlEl.classList.remove('dark');
        moonIcon.classList.remove('hidden');
        sunIcon.classList.add('hidden');
    }
}
themeToggleBtn.addEventListener('click', () => {
    htmlEl.classList.toggle('dark');
    const isDark = htmlEl.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    moonIcon.classList.toggle('hidden', isDark);
    sunIcon.classList.toggle('hidden', !isDark);
    if(!document.getElementById('analyticsView').classList.contains('hidden')) renderChart();
});

// --- 2. CORE VARIABLES ---
const LS_KEY = 'todo_tasks_poluv_ultimate_v2'; // Changed key to ensure fresh schema
let tasks = [];
let editingId = null;
let deletingId = null; 
let itemsPerPage = 6;
let currentPage = 1;
let currentFilter = 'all';
let currentSort = 'created_desc';
let currentSearch = '';
let selectedDateOnCalendar = null;
let currentViewDate = new Date();
let chartInstance = null;
let currentCategory = 'all';
let analyticsRange = 'month';

const colorOptions = [
    { id: 'colorOption1', value: '#6FA774', bgClass: 'bg-[#6FA774]' },
    { id: 'colorOption2', value: '#EF4444', bgClass: 'bg-[#EF4444]' },
    { id: 'colorOption3', value: '#3B82F6', bgClass: 'bg-[#3B82F6]' },
    { id: 'colorOption4', value: '#F59E0B', bgClass: 'bg-[#F59E0B]' },
    { id: 'colorOption5', value: '#8B5CF6', bgClass: 'bg-[#8B5CF6]' }
];
const DEFAULT_COLOR = colorOptions[0].value;
const categoryColors = ['#6b5bff', '#f97316', '#facc15', '#22d3ee', '#a855f7', '#34d399', '#f472b6'];
const categoryMeta = {
    Work: { label: 'üíº Work', cardClass: 'bg-green-200 text-green-900', badgeClass: 'bg-green-100 text-green-800' },
    Homework: { label: 'üìö Homework', cardClass: 'bg-blue-200 text-blue-900', badgeClass: 'bg-blue-100 text-blue-700' },
    Meeting: { label: 'üó£Ô∏è Meeting', cardClass: 'bg-red-200 text-red-900', badgeClass: 'bg-red-100 text-red-700' },
    Personal: { label: 'üë§ Personal', cardClass: 'bg-yellow-200 text-yellow-900', badgeClass: 'bg-yellow-100 text-yellow-800' },
    Other: { label: 'üì¶ Other', cardClass: 'bg-purple-200 text-purple-900', badgeClass: 'bg-purple-100 text-purple-800' }
};
const defaultCategoryMeta = { label: 'üìå Task', cardClass: 'bg-slate-200 text-slate-900', badgeClass: 'bg-slate-100 text-slate-700' };


// --- 3. POMODORO VARIABLES ---
let timerInterval = null;
let currentPomoSeconds = 25 * 60;
let isTimerRunning = false;
let activePomoTaskId = null;

const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);
const byPriorityValue = (p) => ({low:1, medium:2, high:3})[p] || 2;
const formatDate = d => {
  if (!d) return '';
  const dt = new Date(d);
  return dt.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
};
const timeFromISO = (iso) => {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
};
const formatTimeValue = (timeStr) => {
    if (!timeStr || typeof timeStr !== 'string') return '';
    const [hh, mm] = timeStr.split(':').map(Number);
    if (Number.isNaN(hh) || Number.isNaN(mm)) return '';
    const suffix = hh >= 12 ? 'PM' : 'AM';
    const hour12 = ((hh + 11) % 12) + 1;
    return `${String(hour12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${suffix}`;
};
const getTimeRange = (task) => {
    const startRaw = task.startTime || timeFromISO(task.startDate);
    const endRaw = task.dueTime || timeFromISO(task.date);
    const start = formatTimeValue(startRaw);
    const end = formatTimeValue(endRaw);
    if (start && end) return `${start} - ${end}`;
    if (start) return `${start}`;
    if (end) return `${end}`;
    return '--';
};
const getVietnamTime = (value) => {
    const base = value ? new Date(value) : new Date();
    const localized = base.toLocaleString('en-US', { timeZone: 'Asia/Ho_Chi_Minh' });
    return new Date(localized);
};
const formatCountdown = (ms) => {
    if (!ms || ms <= 0) return '00h00m';
    const hours = Math.floor(ms / 3600000);
    const minutes = Math.floor((ms % 3600000) / 60000);
    return `${String(hours).padStart(2,'0')}h${String(minutes).padStart(2,'0')}m`;
};
// Determine overdue state within 24h using Vietnam timezone
const getFreshOverdueInfo = (task) => {
    if (!task.date) return null;
    const dueVN = getVietnamTime(task.date);
    const nowVN = getVietnamTime();
    if (nowVN <= dueVN) return null;
    const diff = nowVN - dueVN;
    if (diff > 24 * 60 * 60 * 1000) return null;
    const resetPoint = new Date(nowVN);
    resetPoint.setHours(24, 0, 0, 0);
    return {
        highlight: true,
        countdown: formatCountdown(resetPoint - nowVN),
    };
};
const getAnalyticsThreshold = (range) => {
    const now = new Date();
    const start = new Date(now);
    if (range === 'day') start.setDate(start.getDate() - 1);
    else if (range === 'week') start.setDate(start.getDate() - 7);
    else if (range === 'month') start.setMonth(start.getMonth() - 1);
    else if (range === 'year') start.setFullYear(start.getFullYear() - 1);
    else start.setFullYear(start.getFullYear() - 5);
    return start.getTime();
};
const getTaskTimestamp = (task) => {
    if (typeof task.created === 'number') return task.created;
    const parsed = Date.parse(task.startDate || task.date);
    return Number.isNaN(parsed) ? Date.now() : parsed;
};
const filterTasksByRange = (arr, range) => {
    const threshold = getAnalyticsThreshold(range);
    return arr.filter(t => {
        const ts = getTaskTimestamp(t);
        return ts >= threshold;
    });
};

function getISOWeek(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

// --- 4. DATA HANDLING ---
function loadTasks(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    tasks = raw ? JSON.parse(raw) : [];
  } catch(e){ tasks = []; }
}
function saveTasks(){
  localStorage.setItem(LS_KEY, JSON.stringify(tasks));
  checkNotifications();
  renderTodaySchedule();
}
function seedIfEmpty(){
  if (tasks.length) return;
  const now = Date.now();
  const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
  tasks = [
    { id: uid(), title: 'Learn Javascript', desc:'Master the language.', category: 'Homework', startDate: new Date(now).toISOString(), date: new Date(now+86400000).toISOString(), startTime:'07:00', dueTime:'09:00', priority:'high', color:'#6FA774', completed:false, notify: false, created: now },
    { id: uid(), title: 'Team Meeting', desc:'Discuss project roadmap.', category: 'Meeting', startDate: new Date(now).toISOString(), date: new Date(now+86400000).toISOString(), startTime:'10:00', dueTime:'11:00', priority:'medium', color:'#EF4444', completed:false, notify: true, created: now-1000 },
    { id: uid(), title: 'Buy Groceries', desc:'Milk, Eggs, Bread.', category: 'Personal', startDate: new Date(now).toISOString(), date: tomorrow.toISOString(), startTime:'18:00', dueTime:'19:00', priority:'low', color:'#3B82F6', completed:false, notify: false, created: now-500 },
  ];
  saveTasks();
}

function renderColorOptions(){
    const container = document.getElementById('colorPickerContainer');
    if (!container) return;
    container.innerHTML = colorOptions.map((opt, index) => `
        <div class="relative">
            <input type="radio" name="taskColor" id="${opt.id}" value="${opt.value}" class="sr-only color-radio"${index === 0 ? ' checked' : ''}>
            <label for="${opt.id}" class="block w-8 h-8 rounded-full cursor-pointer border-2 border-white dark:border-slate-600 shadow-sm transition-transform ring-gray-400 ${opt.bgClass}"></label>
        </div>
    `).join('');
}

function setSelectedColor(value = DEFAULT_COLOR){
    const radios = document.getElementsByName('taskColor');
    let matched = false;
    for (const radio of radios){
        if (radio.value === value){
            radio.checked = true;
            matched = true;
        }
    }
    if (!matched && radios.length){
        radios[0].checked = true;
    }
}

// --- 5. CALENDAR LOGIC ---
function renderCalendar(){
  const elDate = document.getElementById('calendar');
  const elWeeks = document.getElementById('calendarWeeks');
  const elMonthTitle = document.getElementById('currentMonth');

  const year = currentViewDate.getFullYear();
  const month = currentViewDate.getMonth();
  
  const mNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  elMonthTitle.innerText = mNames[month] + " " + year;
  
  const today = new Date();
  document.getElementById('currentFullDate').innerText = `${String(today.getDate()).padStart(2,'0')}, ${mNames[today.getMonth()]} ${today.getFullYear()}`;

  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0);
  const startDay = first.getDay(); 
  const daysInMonth = last.getDate();

  let htmlDays = '<div class="grid grid-cols-7 gap-y-2 gap-x-1 text-xs mb-2 border-b border-gray-100 dark:border-slate-700 pb-2">';
  const dayNames = ['Su','Mo','Tu','We','Th','Fr','Sa'];
  dayNames.forEach(d => htmlDays += `<div class="text-center font-bold text-gray-400 uppercase tracking-wider">${d}</div>`);
  htmlDays += '</div><div class="grid grid-cols-7 gap-y-2 gap-x-1">';
  
  for (let i=0;i<startDay;i++) htmlDays += `<div></div>`;

  // Build quick lookup for task start dates (ISO)
  const taskStartDates = new Set(tasks.map(t => (t.startDate ? new Date(t.startDate).toISOString().slice(0,10) : null)).filter(Boolean));
  
  for (let d=1; d<=daysInMonth; d++){
    const cellDate = new Date(year, month, d, 12, 0, 0); 
    const iso = cellDate.toISOString().slice(0,10);
    const isToday = cellDate.toDateString() === today.toDateString();
    const hasTaskStart = taskStartDates.has(iso);
    
    let btnClass = "w-8 h-8 rounded-full flex items-center justify-center mx-auto text-sm transition hover:bg-gray-100 dark:hover:bg-slate-700 dark:text-gray-300";
    if (selectedDateOnCalendar === iso) {
        btnClass = "w-8 h-8 rounded-full flex items-center justify-center mx-auto text-sm bg-gray-800 text-white dark:bg-indigo-500 shadow-md";
    } else if (isToday) {
        btnClass = "w-8 h-8 rounded-full flex items-center justify-center mx-auto text-sm bg-pink-200 text-pink-800 font-bold";
    }
    htmlDays += `
      <div class="flex flex-col items-center gap-1">
        <button data-iso="${iso}" class="${btnClass}">${d}</button>
        ${hasTaskStart ? '<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span>' : '<span class="w-1.5 h-1.5"></span>'}
      </div>`;
  }
  htmlDays += '</div>';
  elDate.innerHTML = htmlDays;

  // Weeks
  const totalSlots = startDay + daysInMonth;
  const numRows = Math.ceil(totalSlots / 7);
  let htmlWeeks = '';
  let currentProcessingDate = new Date(year, month, 1 - startDay);
  for(let r=0; r<numRows; r++) {
      const weekNum = getISOWeek(currentProcessingDate);
      htmlWeeks += `<div class="h-8 w-6 flex items-center justify-center bg-pink-50 dark:bg-slate-700 rounded text-[10px] font-bold text-pink-800 dark:text-pink-300 mb-[0px]">${weekNum}</div>`;
      currentProcessingDate.setDate(currentProcessingDate.getDate() + 7);
  }
  elWeeks.innerHTML = htmlWeeks;

  elDate.querySelectorAll('button[data-iso]').forEach(btn => {
    btn.addEventListener('click', () => {
      const val = btn.getAttribute('data-iso');
      selectedDateOnCalendar = (selectedDateOnCalendar === val) ? null : val;
      renderCalendar(); 
      renderTasks();
    });
  });
}
function changeMonth(step) {
    currentViewDate.setMonth(currentViewDate.getMonth() + step);
    renderCalendar();
}

// Calendar Settings Modal Logic
const dateModal = document.getElementById('dateSelectModal');
document.getElementById('btnOpenCalendarSettings').addEventListener('click', () => {
    document.getElementById('selectMonth').value = currentViewDate.getMonth();
    document.getElementById('inputYear').value = currentViewDate.getFullYear();
    dateModal.classList.remove('hidden');
    dateModal.classList.add('flex');
});
document.getElementById('btnCloseDateModal').addEventListener('click', () => {
    dateModal.classList.add('hidden');
    dateModal.classList.remove('flex');
});
document.getElementById('btnApplyDate').addEventListener('click', () => {
    const m = parseInt(document.getElementById('selectMonth').value);
    const y = parseInt(document.getElementById('inputYear').value);
    if (!isNaN(m) && !isNaN(y)) {
        currentViewDate.setFullYear(y);
        currentViewDate.setMonth(m);
        renderCalendar();
    }
    dateModal.classList.add('hidden');
    dateModal.classList.remove('flex');
});


// --- 6. NOTIFICATION LOGIC ---
function checkNotifications() {
    const now = new Date();
    const next24h = new Date(now.getTime() + 24 * 60 * 60 * 1000);
    const urgentTasks = tasks.filter(t => {
        if(!t.date || t.completed || !t.notify) return false;
        const d = new Date(t.date);
        return d >= now && d <= next24h;
    });
    const badge = document.getElementById('notifBadge');
    const bell = document.getElementById('bellIcon');
    const list = document.getElementById('notifList');
    if (urgentTasks.length > 0) {
        badge.innerText = urgentTasks.length;
        badge.classList.remove('hidden');
        bell.classList.add('text-red-500', 'bell-animate');
        list.innerHTML = urgentTasks.map(t => `<li class="font-medium text-red-600 border-b dark:border-slate-700 pb-1 mb-1 last:border-0">‚Ä¢ ${escapeHtml(t.title)}</li>`).join('');
    } else {
        badge.classList.add('hidden');
        bell.classList.remove('text-red-500', 'bell-animate');
        list.innerHTML = '<li class="text-gray-400 italic">No upcoming tasks</li>';
    }
}
function requestNotificationPermission() {
    if ("Notification" in window) Notification.requestPermission();
}

// --- 7. TOGGLE VIEWS & CHARTS ---
function toggleViewMode() {
    const list = document.getElementById('listView');
    const analytics = document.getElementById('analyticsView');
    const iconList = document.getElementById('iconList');
    const iconChart = document.getElementById('iconChart');

    if (list.classList.contains('hidden')) {
        list.classList.remove('hidden');
        analytics.classList.add('hidden');
        iconList.classList.remove('hidden');
        iconChart.classList.add('hidden');
    } else {
        list.classList.add('hidden');
        analytics.classList.remove('hidden');
        iconList.classList.add('hidden');
        iconChart.classList.remove('hidden');
        renderChart();
    }
}
function renderChart() {
    const chartCanvas = document.getElementById('taskChart');
    if (!chartCanvas) return;
    const ctx = chartCanvas.getContext('2d');

    const filtered = filterTasksByRange(tasks, analyticsRange);
    const completedCount = filtered.filter(t => t.completed).length;
    const pendingCount = filtered.filter(t => !t.completed).length;

    const completedEl = document.getElementById('overviewCompleted');
    const pendingEl = document.getElementById('overviewPending');
    const totalOpenEl = document.getElementById('openTasksTotal');

    if (completedEl) completedEl.innerText = completedCount;
    if (pendingEl) pendingEl.innerText = pendingCount;

    const openTasks = filtered.filter(t => !t.completed);
    const totalOpen = openTasks.length;
    if (totalOpenEl) totalOpenEl.innerText = totalOpen;

    const categoryCounts = {};
    openTasks.forEach(task => {
        const label = task.category || 'Other';
        categoryCounts[label] = (categoryCounts[label] || 0) + 1;
    });

    let labels = Object.keys(categoryCounts);
    let data = labels.map(label => categoryCounts[label]);
    let colors = labels.map((_, idx) => categoryColors[idx % categoryColors.length]);
    const breakdownEl = document.getElementById('categoryBreakdown');

    if (!labels.length) {
        labels = ['No open tasks'];
        data = [1];
        colors = ['#CBD5F5'];
        if (breakdownEl) {
            breakdownEl.innerHTML = `
                <li class="flex items-center justify-between bg-gray-50 dark:bg-slate-700/40 rounded-xl px-4 py-3 border border-gray-100 dark:border-slate-600">
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-gray-300"></span>
                        <span class="font-medium">No open tasks</span>
                    </div>
                    <span class="font-semibold">0%</span>
                </li>
            `;
        }
    } else if (breakdownEl) {
        breakdownEl.innerHTML = labels.map((label, idx) => {
            const percent = totalOpen ? Math.round((data[idx] / totalOpen) * 100) : 0;
            return `
                <li class="flex items-center justify-between bg-gray-50 dark:bg-slate-700/40 rounded-xl px-4 py-3 border border-gray-100 dark:border-slate-600">
                    <div class="flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full shadow-sm" style="background:${colors[idx]}"></span>
                        <div class="flex flex-col">
                            <span class="font-semibold">${label}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">${data[idx]} task${data[idx] > 1 ? 's' : ''}</span>
                        </div>
                    </div>
                    <span class="font-semibold">${percent}%</span>
                </li>
            `;
        }).join('');
    }

    if (chartInstance) chartInstance.destroy();
    const isDark = htmlEl.classList.contains('dark');

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: colors,
                borderColor: isDark ? '#1e293b' : '#ffffff',
                borderWidth: 2,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    enabled: true,
                    backgroundColor: isDark ? '#1f2937' : '#fff',
                    titleColor: isDark ? '#f8fafc' : '#0f172a',
                    bodyColor: isDark ? '#e2e8f0' : '#1f2937',
                    borderColor: isDark ? '#475569' : '#e2e8f0',
                    borderWidth: 1,
                    padding: 10,
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const pct = totalOpen ? Math.round((value / totalOpen) * 100) : 0;
                            return ` ${context.label}: ${value} (${pct}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true
            }
        }
    });
}
// --- 8. POMODORO LOGIC ---
function openPomodoro(taskId) {
    const t = tasks.find(x => x.id === taskId);
    if (!t) return;
    activePomoTaskId = taskId;
    document.getElementById('pomoTaskTitle').innerText = t.title;
    document.getElementById('inputMin').value = 25;
    document.getElementById('inputSec').value = 0;
    updateTimerDisplay(25, 0);
    document.getElementById('pomodoroModal').classList.remove('hidden');
    document.getElementById('pomodoroModal').classList.add('flex');
    isTimerRunning = false;
    togglePomoControls('stop');
    document.getElementById('timerInputs').classList.remove('hidden');
}

function togglePomoControls(state) {
    const btnStart = document.getElementById('btnPomoStart');
    const btnPause = document.getElementById('btnPomoPause');
    const inputs = document.getElementById('timerInputs');
    if (state === 'running') {
        btnStart.classList.add('hidden');
        btnPause.classList.remove('hidden');
        inputs.classList.add('hidden');
    } else {
        btnStart.classList.remove('hidden');
        btnPause.classList.add('hidden');
    }
}

function updateTimerDisplay(min, sec) {
    const m = String(min).padStart(2,'0');
    const s = String(sec).padStart(2,'0');
    document.getElementById('timerDisplay').innerText = `${m}:${s}`;
}

function startPomodoro() {
    if (!isTimerRunning) {
        if (currentPomoSeconds === null || currentPomoSeconds === 0) {
            const m = parseInt(document.getElementById('inputMin').value) || 25;
            const s = parseInt(document.getElementById('inputSec').value) || 0;
            currentPomoSeconds = m * 60 + s;
        }
        isTimerRunning = true;
        togglePomoControls('running');
        timerInterval = setInterval(() => {
            if (currentPomoSeconds <= 0) {
                finishPomodoro();
            } else {
                currentPomoSeconds--;
                const m = Math.floor(currentPomoSeconds / 60);
                const s = currentPomoSeconds % 60;
                updateTimerDisplay(m, s);
            }
        }, 1000);
    }
}

function pausePomodoro() {
    isTimerRunning = false;
    clearInterval(timerInterval);
    togglePomoControls('stop');
}

function cancelPomodoro() {
    pausePomodoro();
    currentPomoSeconds = null;
    document.getElementById('pomodoroModal').classList.add('hidden');
    document.getElementById('pomodoroModal').classList.remove('flex');
}

function finishPomodoro() {
    pausePomodoro();
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    osc.connect(audioCtx.destination);
    osc.start();
    setTimeout(() => osc.stop(), 500);

    if (confirm("Time's up! üéâ\nDo you want to mark this task as Completed?")) {
        toggleComplete(activePomoTaskId);
    }
    cancelPomodoro();
}

document.getElementById('btnPomoStart').addEventListener('click', startPomodoro);
document.getElementById('btnPomoPause').addEventListener('click', pausePomodoro);
document.getElementById('btnPomoCancel').addEventListener('click', cancelPomodoro);

// --- 9. TASK CRUD ---
function getFilteredSortedTasks(){
  let arr = tasks.slice();
  if (selectedDateOnCalendar) arr = arr.filter(t => (t.date ? t.date.slice(0,10) : '') === selectedDateOnCalendar);
  if (currentFilter === 'completed') arr = arr.filter(t => t.completed);
  if (currentFilter === 'pending') arr = arr.filter(t => !t.completed);
  if (currentCategory !== 'all') arr = arr.filter(t => (t.category || '').toLowerCase() === currentCategory.toLowerCase());
  if (currentSearch.trim()){
    const q = currentSearch.trim().toLowerCase();
    arr = arr.filter(t => (t.title||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q));
  }
  if (currentSort === 'created_desc') arr.sort((a,b)=> (b.created||0) - (a.created||0));
  if (currentSort === 'priority_desc') arr.sort((a,b)=> byPriorityValue(b.priority) - byPriorityValue(a.priority));
  return arr;
}

// Pastel task cards + overdue handling
function renderTasks(){
  const container = document.getElementById('taskList');
  const arr = getFilteredSortedTasks();
  const total = arr.length;
  const end = Math.min(currentPage * itemsPerPage, total);
  const visible = arr.slice(0, end);

  container.innerHTML = visible.map(t => {
    const isDone = t.completed;
    const category = t.category || 'Other';
    const categoryInfo = categoryMeta[category] || defaultCategoryMeta;
    const timeRangeText = getTimeRange(t);
    const overdueInfo = getFreshOverdueInfo(t);
    const cardClass = overdueInfo?.highlight
        ? 'bg-red-100 text-red-900 border border-red-200'
        : `${categoryInfo.cardClass} border border-white/70`;
    const titleClass = isDone ? 'font-bold text-lg truncate w-full line-through opacity-70' : 'font-bold text-lg truncate w-full';
    const descClass = isDone ? 'text-sm opacity-70 truncate' : 'text-sm truncate';
    const timePillClass = overdueInfo?.highlight
        ? 'bg-red-200/80 text-red-900'
        : 'bg-white/60 text-gray-700';
    const focusButton = isDone ? '' : `
        <button type="button" onclick="openPomodoro('${t.id}')" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 transition" title="Start Focus">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </button>`;
    const overdueBadge = overdueInfo?.highlight
        ? `<span class="text-xs font-semibold text-red-600">Overdue ‚Ä¢ resets in ${overdueInfo.countdown}</span>`
        : '';

    return `
      <div class="relative p-5 rounded-3xl smooth-shadow hover:-translate-y-0.5 transition-transform group flex flex-col gap-3 min-h-[140px] ${cardClass}">
        <div class="flex items-center justify-between gap-3">
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${categoryInfo.badgeClass}">${categoryInfo.label}</span>
                    ${overdueBadge}
                </div>
                <h4 class="${titleClass}" title="${escapeHtml(t.title)}">${escapeHtml(t.title)}</h4>
            </div>
            ${focusButton}
        </div>
        <p class="${descClass}">${escapeHtml(t.desc)}</p>
        <div class="flex justify-between items-center mt-auto">
            <div class="flex items-center gap-1.5 px-3 py-1 rounded-lg ${timePillClass}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium tracking-wide">${timeRangeText}</span>
            </div>
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button data-id="${t.id}" class="editTaskBtn bg-white/50 text-gray-700 p-1.5 rounded-lg hover:bg-white">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </button>
                <button data-id="${t.id}" class="completeTaskBtn bg-white/50 text-gray-700 p-1.5 rounded-lg hover:bg-white">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                </button>
                <button data-id="${t.id}" class="deleteTaskBtn bg-white/50 text-gray-700 p-1.5 rounded-lg hover:bg-white" title="Delete task">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3H4" />
                    </svg>
                </button>
            </div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('statCompleted').innerText = String(tasks.filter(t=>t.completed).length).padStart(2,'0');
  document.getElementById('statPending').innerText = String(tasks.filter(t=>!t.completed).length).padStart(2,'0');
  document.getElementById('statTotal').innerText = tasks.length.toLocaleString();

  container.querySelectorAll('.completeTaskBtn').forEach(el => el.addEventListener('click', () => toggleComplete(el.dataset.id)));
  container.querySelectorAll('.editTaskBtn').forEach(b => b.addEventListener('click', () => openEditModal(b.dataset.id)));
  container.querySelectorAll('.deleteTaskBtn').forEach(b => b.addEventListener('click', () => confirmDelete(b.dataset.id)));

  const loadMoreBtn = document.getElementById('btnLoadMore');
  if (loadMoreBtn) {
      loadMoreBtn.style.display = (end >= total) ? 'none' : 'block';
  }
  const analyticsSection = document.getElementById('analyticsView');
  if (analyticsSection && !analyticsSection.classList.contains('hidden')) {
      renderChart();
  }
  checkNotifications();
  renderTodaySchedule();
}

// Render Today's Schedule sidebar
function renderTodaySchedule() {
    const todayStr = new Date().toISOString().slice(0, 10);
    const todayTasks = tasks.filter(t => {
        if (!t.date) return false;
        const taskDate = t.date.slice(0, 10);
        return taskDate === todayStr && !t.completed;
    }).sort((a, b) => {
        const timeA = a.startTime || a.dueTime || '';
        const timeB = b.startTime || b.dueTime || '';
        return timeA.localeCompare(timeB);
    });

    const container = document.getElementById('todayList');
    const dateDisplay = document.getElementById('todayDateDisplay');
    
    if (!container || !dateDisplay) return;

    // Update date display
    const today = new Date();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    dateDisplay.innerText = `${monthNames[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;

    if (todayTasks.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4 italic">No tasks for today. Relax! ‚òï</div>';
        return;
    }

    const categoryColors = {
        'Work': 'bg-green-400',
        'Homework': 'bg-blue-400',
        'Meeting': 'bg-red-400',
        'Personal': 'bg-yellow-400',
        'Other': 'bg-purple-400'
    };

    container.innerHTML = todayTasks.map(t => {
        const category = t.category || 'Other';
        const colorClass = categoryColors[category] || 'bg-gray-400';
        const timeRange = getTimeRange(t);
        
        return `
            <div class="flex gap-3 items-center group cursor-pointer" onclick="openEditModal('${t.id}')">
                <div class="w-1 h-10 rounded-full ${colorClass}"></div>
                <div class="flex-1">
                    <div class="text-sm font-semibold text-gray-800 dark:text-gray-200 line-clamp-1 group-hover:text-pink-500 dark:group-hover:text-pink-400 transition">${escapeHtml(t.title)}</div>
                    <div class="text-xs text-gray-400">${timeRange}</div>
                </div>
            </div>
        `;
    }).join('');
}

function escapeHtml(str){ 
    return String(str||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;'); 
}
function toggleComplete(id){ const t = tasks.find(x=>x.id===id); if(t) { t.completed = !t.completed; saveTasks(); renderTasks(); } }

function openAddModal(){
    editingId = null;
    document.getElementById('modalTitle').innerText = 'New Task';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    document.getElementById('taskCategory').value = 'Work'; // Default category
    document.getElementById('taskStartDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('taskStartTime').value = '';
    document.getElementById('taskDueDate').value = selectedDateOnCalendar || new Date().toISOString().slice(0,10);
    document.getElementById('taskDueTime').value = '';
    document.getElementById('taskPriority').value = 'medium';
    document.getElementById('taskNotify').checked = false;
    setSelectedColor();
    
    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
}
function openEditModal(id){
    const t = tasks.find(x=>x.id===id); if(!t) return;
    editingId = id;
    document.getElementById('modalTitle').innerText = 'Edit Task';
    document.getElementById('taskTitle').value = t.title;
    document.getElementById('taskDesc').value = t.desc;
    document.getElementById('taskCategory').value = t.category || 'Work';
    document.getElementById('taskStartDate').value = t.startDate ? t.startDate.slice(0,10) : '';
    document.getElementById('taskStartTime').value = t.startTime || '';
    document.getElementById('taskDueDate').value = t.date ? t.date.slice(0,10) : '';
    document.getElementById('taskDueTime').value = t.dueTime || '';
    document.getElementById('taskPriority').value = t.priority;
    document.getElementById('taskNotify').checked = t.notify || false;
    setSelectedColor(t.color || DEFAULT_COLOR);

    document.getElementById('modalBackdrop').classList.remove('hidden');
    document.getElementById('modalBackdrop').classList.add('flex');
}

// Custom Delete Modal Functions
const deleteModal = document.getElementById('deleteModal');
function confirmDelete(id){ 
    deletingId = id;
    deleteModal.classList.remove('hidden');
    deleteModal.classList.add('flex');
}
document.getElementById('btnCancelDelete').addEventListener('click', () => {
    deletingId = null;
    deleteModal.classList.add('hidden');
    deleteModal.classList.remove('flex');
});
document.getElementById('btnConfirmDelete').addEventListener('click', () => {
    if (deletingId) {
        tasks = tasks.filter(t => t.id !== deletingId);
        saveTasks();
        renderTasks();
    }
    deletingId = null;
    deleteModal.classList.add('hidden');
    deleteModal.classList.remove('flex');
});


document.getElementById('btnAdd').addEventListener('click', openAddModal);
document.getElementById('cancelModal').addEventListener('click', () => { document.getElementById('modalBackdrop').classList.add('hidden'); document.getElementById('modalBackdrop').classList.remove('flex'); });

document.getElementById('taskForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const title = document.getElementById('taskTitle').value.trim(); if(!title) return;
    const desc = document.getElementById('taskDesc').value.trim();
    const category = document.getElementById('taskCategory').value;
    const startDate = document.getElementById('taskStartDate').value;
    const startTime = document.getElementById('taskStartTime').value;
    const date = document.getElementById('taskDueDate').value;
    const dueTime = document.getElementById('taskDueTime').value;
    const priority = document.getElementById('taskPriority').value;
    const notify = document.getElementById('taskNotify').checked;
    
    const color = document.querySelector('input[name="taskColor"]:checked')?.value || DEFAULT_COLOR;
    
    if(editingId){
        const t = tasks.find(x=>x.id===editingId);
        if(t){ 
            t.title=title; 
            t.desc=desc; 
            t.category=category;
            t.startDate=startDate;
            t.startTime=startTime;
            t.date=date; 
            t.dueTime=dueTime;
            t.priority=priority; 
            t.color=color;
            t.notify=notify; 
        }
    } else {
        tasks.unshift({ id:uid(), title, desc, category, startDate, startTime, date, dueTime, priority, color, completed:false, notify, created:Date.now() });
    }
    saveTasks();
    document.getElementById('modalBackdrop').classList.add('hidden');
    document.getElementById('modalBackdrop').classList.remove('flex');
    renderTasks();
});

document.getElementById('searchInput').addEventListener('input', e => { currentSearch = e.target.value; currentPage=1; renderTasks(); });
const filterStatusSelect = document.getElementById('filterStatus');
if (filterStatusSelect) filterStatusSelect.addEventListener('change', e => { currentFilter = e.target.value; currentPage=1; renderTasks(); });
const filterCategorySelect = document.getElementById('filterCategory');
if (filterCategorySelect) filterCategorySelect.addEventListener('change', e => { currentCategory = e.target.value; currentPage=1; renderTasks(); });
document.getElementById('sortSelect').addEventListener('change', e => { currentSort = e.target.value; renderTasks(); });
const loadMoreBtn = document.getElementById('btnLoadMore');
if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => { currentPage++; renderTasks(); });
const analyticsRangeSelect = document.getElementById('analyticsRangeSelect');
if (analyticsRangeSelect) analyticsRangeSelect.addEventListener('change', e => { analyticsRange = e.target.value; renderChart(); });

(function boot(){
    initTheme(); 
    loadTasks();
    seedIfEmpty();
    renderColorOptions();
    renderCalendar();
    renderTasks();
    renderTodaySchedule();
    if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") Notification.requestPermission();
})();

</script>
</body>
</html>